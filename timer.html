<!DOCTYPE html>
<html lang="zh">

<head>
    <title>Timer</title>
    <link rel="icon" type="image/x-icon" class="js-site-favicon" href="https://github.com/favicon.ico">
    <link rel="stylesheet" href="/webTools.css">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
</head>

<body>
    <!-- Timer -->
    <div id="app">
        <p>Timer</p>
        <p>
            <a href="/index.html">back to the contents</a>
        </p>
        <br>
        <table border="1">
            <tr>
                <th>hour</th>
                <th>minute</th>
                <th>second</th>
            </tr>
            <tr>
                <td><input v-model="hour"></td>
                <td><input v-model="minute"></td>
                <td><input v-model="second"></td>
            </tr>
        </table>
        <button @click="start('plus')">plus</button>
        <button @click="start('minus')">minus</button>
        <button @click="start(null)">continue</button>
        <button @click="stop()">stop</button>
        <hr>
        {{text_time}}
    </div>
</body>
<script>
    let app = new Vue({
        el: "#app",
        data: {
            hour: 0,
            minute: 0,
            second: 0,
            core_hour: 0,
            core_minute: 0,
            core_second: 0,
            interval: null,
            model: null
        },
        created() {
            let t = this;
            let storage = window.localStorage;
            if (!storage) return false;
            let history = storage.getItem("jiehuifang_timer")
            if(history !== null) {
                let temp = JSON.parse(history);
                t.hour = temp.hour;
                t.minute = temp.minute;
                t.second = temp.second;
            }
            if (undefined !== window.Notification && "granted" !== Notification.permission) {
                Notification.requestPermission();
            }
        },
        computed: {
            core_time() {
                let core = 0;
                core += this.core_hour * 3600;
                core += this.core_minute * 60;
                core += this.core_second * 1;
                return core;
            },
            text_time() {
                let core = this.core_time;
                let hour_num = parseInt(core / 3600);
                core = core - hour_num * 3600;
                let minute_num = parseInt(core / 60);
                core = core - minute_num * 60;
                return hour_num + 'hour ' + minute_num + 'minute ' + core + 'second';
            }
        },
        methods: {
            start(model) {
                let t = this;
                if(model === null && t.model === null) {
                    alert('frist start');
                    return;
                }
                if (model !== null) {
                    let storage = window.localStorage;
                    let temp = {
                        hour: t.hour,
                        minute: t.minute,
                        second: t.second
                    };
                    if (storage) storage.setItem("jiehuifang_timer", JSON.stringify(temp));
                    t.core_second = parseInt(t.second)
                    t.core_minute = parseInt(t.minute)
                    t.core_hour = parseInt(t.hour)
                    t.model = model;
                }
                if(t.interval !== null) {
                    alert('already started');
                    return;
                }
                if(this.model === 'plus') {
                    t.interval = setInterval(() => {
                        t.core_second += 1
                    }, 1000);
                }else {
                    t.interval = setInterval(() => {
                        t.core_second -= 1
                        if (t.core_time <= 0) {
                            t.showNotification('Time Out!')
                            t.stop();
                        }
                    }, 1000);
                }
            },
            stop() {
                let t = this;
                clearInterval(t.interval);
                t.interval = null;
            },
            showNotification(msg) {
                let t = this;
                if (Notification.permission == "granted") {
                    t.showWindowNotification(msg);
                } else {
                    console.log("Notification Permission:" + Notification.permission);
                }
            },
            showWindowNotification(msg) {
                let notification = new Notification("Timer", {
                    dir: "auto",
                    icon: '/dog.ico',
                    body: msg,
                    renotify: true,
                    tag: 'Timer',
                    requireInteraction: true
                });
                notification.onclick = () => {
                    window.focus();
                }
            }
        }
    });
</script>

</html>