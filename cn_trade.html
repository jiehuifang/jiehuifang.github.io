<!DOCTYPE html>
<html lang="zh">
<head>
    <title>CN Trade</title>
    <link rel="icon" type="image/x-icon" class="js-site-favicon" href="https://github.githubassets.com/favicon.ico">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body style="text-align: center">
<!-- CN Trade -->
<div>
    <p>CN Trade </p>
    <p>
        <a href="https://jiehuifang.github.io/">back to the contents</a>
    </p>
    <br>
    <div>
        <textarea id="trade_code" rows="5" cols="30" placeholder="input code"></textarea>
    </div>
    <div>
        <textarea id="trade_result" rows="5" cols="30" placeholder="show result" readonly></textarea>
    </div>
    <div>
        <!-- button -->
        <input value="refresh" type="button" onclick="trade_refresh()">
        <input value="stop" type="button" onclick="stopInterval()">
    </div>
</div>
</body>
<script>
    let codes;
    let refreshInterval;
    let instance = axios.create({
        //腾讯 tx
        baseURL: 'https://qt.gtimg.cn'//v_s_sh600108="1~亚盛集团~600108~3.00~-0.10~-3.23~568256~17082~~58.41~GP-A";
    });

    function refreshFun() {
        console.log('refresh run: ' + codes);
        try {
            document.getElementById("trade_result").innerHTML = '';
            codes.forEach((element) => {
                instance.get('/q=' + element).then((res) => {
                    let data = res.data.split('~');
                    let tx_data = data[2] + '  ' + data[3] + '  ' + data[4] + '  ' + data[5] + '%'
                    if (document.getElementById("trade_result").innerHTML !== '') {
                        document.getElementById("trade_result").innerHTML = document.getElementById("trade_result").innerHTML + '\n' + tx_data;
                    } else {
                        document.getElementById("trade_result").innerHTML = tx_data;
                    }
                }).catch((e) => {
                    console.log(e)
                });
            });
        } catch (err) {
            console.log(err);
            stopInterval();
        }
    }

    function stopInterval() {
        if (refreshInterval !== undefined && refreshInterval !== null) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    function trade_refresh() {
        //clean history
        document.getElementById("trade_result").innerHTML = '';
        stopInterval();
        codes = document.getElementById("trade_code").value.split('\n');
        refreshInterval = setInterval(refreshFun, 3000)
    }
</script>
</html>